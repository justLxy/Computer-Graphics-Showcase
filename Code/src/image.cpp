#include "image.h"
#include <fstream>
#include <array>

void Image::fill(const Vec3& c){
	for(auto& p : pixels) p = c;
}

bool Image::write_ppm(const std::string& path) const{
	std::ofstream out(path, std::ios::binary);
	if(!out) return false;
	out<<"P6\n"<<width<<" "<<height<<"\n255\n";
	for(const auto& p : pixels){
		const Vec3 c = clamp01(p);
		const std::array<unsigned char,3> b = {to_u8(c.x), to_u8(c.y), to_u8(c.z)};
		out.write(reinterpret_cast<const char*>(b.data()), 3);
	}
	return true;
}

void Image::overlay_rect(int x0,int y0,int w,int h,const Vec3& color,double alpha){
	const double a = std::min(1.0,std::max(0.0,alpha));
	for(int y=y0;y<y0+h;++y){
		for(int x=x0;x<x0+w;++x){
			if(x<0||x>=width||y<0||y>=height) continue;
			Vec3 base = get(x,y);
			set(x,y, base*(1.0-a) + color*a);
		}
	}
}

// Minimal 8x8 bitmap font (ASCII 32..127), taken from public-domain tiny bitmap font tables
// Each character represented as 8 bytes, one per row, MSB->LSB
static const unsigned char kFont8x8[][8] = {
	// 32..47
	{0,0,0,0,0,0,0,0},{0x18,0x3C,0x3C,0x18,0x18,0,0x18,0}, {0x36,0x36,0x24,0,0,0,0,0},
	{0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0}, {0x18,0x7E,0x03,0x3E,0x60,0x3F,0x18,0},
	{0x00,0x63,0x66,0x0C,0x18,0x33,0x63,0}, {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0},
	{0x30,0x30,0x60,0,0,0,0,0}, {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0}, {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0},
	{0x00,0x66,0x3C,0xFF,0x3C,0x66,0,0}, {0x00,0x18,0x18,0x7E,0x18,0x18,0,0}, {0,0,0,0,0,0x18,0x18,0x30},
	{0,0,0,0x7E,0,0,0,0}, {0,0,0,0,0,0,0x18,0x18}, {0x03,0x06,0x0C,0x18,0x30,0x60,0xC0,0},
	// 48..63
	{0x3E,0x63,0x67,0x6F,0x7B,0x73,0x3E,0}, {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0},
	{0x3E,0x63,0x03,0x0E,0x38,0x63,0x7F,0}, {0x3E,0x63,0x03,0x1E,0x03,0x63,0x3E,0},
	{0x06,0x0E,0x1E,0x36,0x66,0x7F,0x06,0}, {0x7F,0x60,0x7E,0x03,0x03,0x63,0x3E,0},
	{0x1E,0x30,0x60,0x7E,0x63,0x63,0x3E,0}, {0x7F,0x63,0x06,0x0C,0x18,0x18,0x18,0},
	{0x3E,0x63,0x63,0x3E,0x63,0x63,0x3E,0}, {0x3E,0x63,0x63,0x3F,0x03,0x06,0x3C,0},
	{0,0x18,0x18,0,0,0x18,0x18,0}, {0,0x18,0x18,0,0,0x18,0x18,0x30},
	{0x0E,0x1C,0x38,0x70,0x38,0x1C,0x0E,0}, {0,0,0x7E,0,0x7E,0,0,0},
	{0x70,0x38,0x1C,0x0E,0x1C,0x38,0x70,0}, {0x3E,0x63,0x06,0x0C,0x18,0,0x18,0},
	// 64..79
	{0x3E,0x63,0x7B,0x7B,0x7B,0x60,0x3E,0}, {0x1C,0x36,0x63,0x7F,0x63,0x63,0x63,0},
	{0x7E,0x33,0x33,0x3E,0x33,0x33,0x7E,0}, {0x1E,0x33,0x60,0x60,0x60,0x33,0x1E,0},
	{0x7C,0x36,0x33,0x33,0x33,0x36,0x7C,0}, {0x7F,0x31,0x34,0x3C,0x34,0x31,0x7F,0},
	{0x7F,0x31,0x34,0x3C,0x34,0x30,0x78,0}, {0x1E,0x33,0x60,0x67,0x63,0x33,0x1F,0},
	{0x63,0x63,0x63,0x7F,0x63,0x63,0x63,0}, {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0},
	{0x0F,0x06,0x06,0x06,0x66,0x66,0x3C,0}, {0x73,0x33,0x36,0x3C,0x36,0x33,0x73,0},
	{0x78,0x30,0x30,0x30,0x31,0x33,0x7F,0}, {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0},
	{0x63,0x73,0x7B,0x6F,0x67,0x63,0x63,0}, {0x3E,0x63,0x63,0x63,0x63,0x63,0x3E,0},
	// 80..95
	{0x7E,0x33,0x33,0x3E,0x30,0x30,0x78,0}, {0x3E,0x63,0x63,0x63,0x6B,0x66,0x3D,0},
	{0x7E,0x33,0x33,0x3E,0x36,0x33,0x73,0}, {0x3C,0x66,0x30,0x1C,0x06,0x66,0x3C,0},
	{0x7E,0x5A,0x18,0x18,0x18,0x18,0x3C,0}, {0x63,0x63,0x63,0x63,0x63,0x63,0x3E,0},
	{0x63,0x63,0x63,0x63,0x36,0x1C,0x08,0}, {0x63,0x63,0x6B,0x7F,0x77,0x63,0x63,0},
	{0x63,0x36,0x1C,0x1C,0x1C,0x36,0x63,0}, {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0},
	{0x7F,0x63,0x06,0x0C,0x18,0x33,0x7F,0}, {0,0,0,0,0,0,0,0} // placeholder for 96
};

static inline const unsigned char* glyph8x8(char c){
	unsigned char uc = static_cast<unsigned char>(c);
	if(uc < 32 || uc > 95) return kFont8x8[0];
	return kFont8x8[uc-32];
}

void Image::draw_text_8x8(int x,int y,const std::string& text,const Vec3& color){
	for(size_t i=0;i<text.size();++i){
		const unsigned char* g = glyph8x8(text[i]);
		for(int ry=0; ry<8; ++ry){
			unsigned char row = g[ry];
			for(int rx=0; rx<8; ++rx){
				if(row & (0x80 >> rx)){
					int px = x + static_cast<int>(i*8 + rx);
					int py = y + ry;
					if(px>=0&&px<width&&py>=0&&py<height){
						set(px,py,color);
					}
				}
			}
		}
	}
}


